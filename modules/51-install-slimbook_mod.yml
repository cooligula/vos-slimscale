name: install-slimbook
type: shell
commands:

  # Slimbook PPA (For the Service & Gestures)
  - curl -fsSL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0xBE80F1EEB3838E61E42091B378A22399981017FC" | gpg --dearmor -o /usr/share/keyrings/slimbook-archive-keyring.gpg
  - echo "deb [signed-by=/usr/share/keyrings/slimbook-archive-keyring.gpg] https://ppa.launchpadcontent.net/slimbook/slimbook/ubuntu jammy main" | tee /etc/apt/sources.list.d/slimbook.list
  
  - apt-get update
  - apt-get install -y slimbook slimbookgestures

  - mkdir -p /sources
  - cd /sources

  # --- 1. SLIMBOOK AMD CONTROLLER (Source Fix: Python Version) ---
  - echo ">>> Installing AMD Controller from Source..."
  - git clone https://github.com/Slimbook-Team/slimbookamdcontroller.git
  - cd slimbookamdcontroller
  - mkdir -p /usr/share/slimbookamdcontroller
  - cp -r src/* /usr/share/slimbookamdcontroller/
  - cp slimbookamdcontroller.desktop /usr/share/applications/
  # Create launcher
  - echo '#!/bin/bash\ncd /usr/share/slimbookamdcontroller/src/ && python3 slimbookamdcontroller.py "$@"' > /usr/bin/slimbookamdcontroller
  - chmod +x /usr/bin/slimbookamdcontroller
  # Fix the python module that caused the crash
  - pip3 install --break-system-packages --upgrade pyamdgpuinfo
  - cd ..

  # --- 2. SLIMBOOK BATTERY (Source Fix: Ayatana/Icon Support) ---
  - echo ">>> Installing Slimbook Battery from Source..."
  - git clone https://github.com/Slimbook-Team/slimbookbattery.git
  - cd slimbookbattery
  - mkdir -p /usr/share/slimbookbattery
  - cp -r src/* /usr/share/slimbookbattery/
  - cp slimbookbattery.desktop /usr/share/applications/
  # Create launcher
  - echo '#!/bin/bash\ncd /usr/share/slimbookbattery/ && python3 slimbookbattery.py "$@"' > /usr/bin/slimbookbattery
  - chmod +x /usr/bin/slimbookbattery
  # Install Schemas
  - cp slimbookbattery.gschema.xml /usr/share/glib-2.0/schemas/
  - glib-compile-schemas /usr/share/glib-2.0/schemas/
  
  # AUTO-PATCH: Force AppIndicator to use Ayatana if needed
  # This command finds "import AppIndicator3" and adds the Ayatana require line before it
  - find /usr/share/slimbookbattery -name "*.py" -print0 | xargs -0 sed -i "s/from gi.repository import AppIndicator3/import gi\ngi.require_version('AyatanaAppIndicator3', '0.1')\nfrom gi.repository import AyatanaAppIndicator3 as AppIndicator3/g" || true
  - cd ..

  # --- 3. SLIMBOOK FACE (Source Fix: Dlib Dependencies) ---
  - echo ">>> Installing Slimbook Face from Source..."
  - git clone https://github.com/Slimbook-Team/slimbookface.git
  - cd slimbookface
  - mkdir -p /usr/share/slimbookface
  - cp -r * /usr/share/slimbookface/
  - cp slimbookface.desktop /usr/share/applications/
  # Create launcher
  - echo '#!/bin/bash\ncd /usr/share/slimbookface/ && python3 slimbookface.py "$@"' > /usr/bin/slimbookface
  - chmod +x /usr/bin/slimbookface
  - cd ..